{% extends "base/base.html" %}
{% load static %}
{% block titulo %}| Aplicacion{% endblock %}
{% block titulo_seccion %}Aplicacion{% endblock %}
{% block seccion %}
    <div class="w3-white w3-half w3-margin w3-padding w3-round-large">
        <form method="post">
            {% csrf_token %}
            <div class="w3-container w3-center">
                <h4>{{ app.name }}</h4>
            </div>
            <div id="id_error" class="w3-leftbar w3-rightbar w3-padding-left w3-margin w3-center w3-text-red w3-border-red" style="display: none">
                <p>Necesitas completar el formulario</p>
            </div>
            {% for ask in askApplication %}
                <div id="id_ask_{{ ask.pk }}">
                    <h5>{{ ask.order }} - {{ ask.askBody }}</h5>
                    {% if ask.askType == "o" %}
                        <select data-ask="{{ ask.pk }}" id="id_ask_select_{{ ask.pk }}" class="ask-select w3-select w3-border w3-validate w3-round es-shadow">
                        <option selected disabled value="0">Seleccionar</option>
                        {% for option in ask.options %}
                            <option value="{{ option.pk }}">{{ option.option }}</option>
                        {% endfor %}
                        </select>
                    {% else %}
                        <div class="w3-row">
                            <div class="w3-half">
                                <p class="w3-tiny w3-opacity">Sea conciso solo tiene {{ ask.textMax }} caracteres. Al menos escriba 20 caracteres</p>
                            </div>
                            <div class="w3-right">
                                <p class="w3-tiny w3-opacity w3-text-deep-orange" id="id_ask_textarea_ind_{{ ask.pk }}">0/{{ ask.textMax }}</p>
                            </div>
                        </div>
                        
                        <textarea data-ask="{{ ask.pk }}" id="id_ask_textarea_{{ ask.pk }}" oninput="$('#id_ask_textarea_ind_{{ ask.pk }}').html($(this).val().length  + '/{{ ask.textMax }}')" class="ask-textarea w3-input w3-border w3-validate w3-round es-shadow" placeholder="Escriba su respuesta" maxlength="{{ ask.textMax }}" rows="4" cols="50"></textarea>
                    {% endif %}
                </div>
            {% endfor %}
            <br><br>
            <div class="w3-container w3-center">
                <input type="submit" id="id_send" value="Enviar" class="w3-btn w3-blue w3-large w3-animate-bottom w3-round-large es-shadow-large" tyle="background-color: #4c4b4b;">
            </div>
        </form>
    </div>

    <script>
        $("#id_send").on("click", function(e){
            e.preventDefault();

            let asks = [];

            const askselects = $(".ask-select");
            const asktextareas = $(".ask-textarea");

            let enviarForm = true;

            askselects.map(function(iter, ask){
                if ($(ask).val() != 0){
                    asks.push([{{ student }}, $(ask).attr("data-ask"), "o", $(ask).val()]);
                }else{
                    document.getElementById("id_error").style.display = "block";
                    enviarForm = false;
                }
            });

            asktextareas.map(function(iter, ask){
                if ($(ask).val().length > 19){
                    asks.push([{{ student }}, $(ask).attr("data-ask"), "t", $(ask).val()]);
                }else{
                    document.getElementById("id_error").style.display = "block";
                    enviarForm = false;
                }
            });

            if (enviarForm){
                asks.map(function (ask, iter){
                    $.ajax({
                        url: "{% url 'view_application_ajax' %}",
                        type: "POST",
                        data: {
                            student: ask[0],
                            ask: ask[1],
                            askType: ask[2],
                            answer: ask[3]
                        },
                        success: function(json){
                            if (json.Exito === 'True'){
                                window.location.replace("{% url 'view_success' student %}");
                            }
                            else{
                                document.getElementById("id_error").style.display = "block";
                            }                        
                        },
                        error: function(xhr, errmsg, err){
                            console.log(errmsg, err);
                        }
                    });
                });
            }
            
        });
    </script>
{% endblock %}